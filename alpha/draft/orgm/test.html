<!doctype html>
<html>
<body>
  <img src="tmpl.png" style="vertical-align:top;width:200px;height:200px;" />
  <img src="test.png" style="vertical-align:top;" />
  </br/>
  <canvas id="cv"></canvas>
<script>
!function() {

  var updateCanvas = function() {

    var ctx = document.getElementById('cv').getContext('2d');

    var size = 500;
    ctx.canvas.width = size * 2;
    ctx.canvas.height = size * 2;

    // bg
    ctx.fillStyle = '#f0f0f0';
    ctx.fillRect(0, 0, size, size);

    var unit = img.height / 4;

    ctx.save();
    ctx.scale(size / 8 / unit, size / 8 / unit);

    var draw = function(path, tran) {

      ctx.save();

      ctx.transform(tran[0], tran[1], tran[2], tran[3],
          tran[4] * unit, tran[5] * unit);
      ctx.beginPath();
      for (var i = 0; i < path.length; i += 2) {
        if (i == 0) {
          ctx.moveTo(path[i] * unit, path[i + 1] * unit);
        } else {
          ctx.lineTo(path[i] * unit, path[i + 1] * unit);
        }
      }
      ctx.closePath();
      ctx.clip();

      ctx.drawImage(img, 0, 0);

      ctx.restore();
    };

    // left
    draw([1, 1, 2, 0, 2, 2], [0, -1, 1, 0, 2, 2]);
    draw([1, 1, 2, 0, 2, 2], [1, 0, 0, -1, 2, 2]);

    draw([1, 1, 2, 2, 2, 3, 1, 3], [1, 0, 0, 1, 2, 2]);
    draw([1, 1, 2, 2, 2, 3, 1, 3], [-1, 0, 0, 1, 4, 2]);
    draw([1, 1, 2, 2, 1, 2], [0, 1, 1, 0, 2, 2]);

    draw([0, 1, 1, 1, 1, 3, 0, 3], [1, 0, 0, 1, 0, 2]);
    draw([0, 1, 1, 1, 1, 3, 0, 3], [-1, 0, 0, 1, 2, 2]);

    // center
    draw([1, 3, 3, 3, 3, 4, 1, 4], [1, 0, 0, 1, 2, 4]);
    draw([1, 3, 3, 3, 3, 4, 1, 4], [1, 0, 0, -1, 2, 10]);

    draw([1, 2, 3, 2, 3, 3, 1, 3], [1, 0, 0, -1, 2, 8]);

    // right
    draw([2, 0, 3, 1, 2, 2], [0, 1, -1, 0, 6, -2]);
    draw([2, 0, 3, 1, 2, 2], [1, 0, 0, -1, 2, 2]);

    draw([3, 1, 3, 3, 2, 3, 2, 2], [1, 0, 0, 1, 2, 2]);
    draw([3, 1, 3, 3, 2, 3, 2, 2], [-1, 0, 0, 1, 8, 2]);
    draw([3, 1, 3, 2, 2, 2], [0, -1, -1, 0, 6, 6]);

    draw([3, 1, 4, 1, 4, 3, 3, 3], [1, 0, 0, 1, 4, 2]);
    draw([3, 1, 4, 1, 4, 3, 3, 3], [-1, 0, 0, 1, 10, 2]);

    ctx.restore();

    // divs.
    var div = 8;
    ctx.strokeStyle = '#999';
    for (var i = 0; i <= div; i += 1) {

      ctx.beginPath();
      ctx.moveTo(0, size / div * i);
      ctx.lineTo(size, size / div * i);
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(size / div * i, 0);
      ctx.lineTo(size / div * i, size);
      ctx.stroke();
    }
  };

  var img = document.createElement('img');
  img.addEventListener('load', function() {
    console.log('loaded', img.width, img.height);
    updateCanvas();
  });
  img.src = 'test.png';

}();
</script>
</body>
</html>
